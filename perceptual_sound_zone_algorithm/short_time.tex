In \autoref{ch:sound_zone:approach_selection} a perceptual sound zone approach is proposed.
This approach is based on the pressure matching sound zone approach discussed in \autoref{ch:sound_zone:approaches}.
In this approach, the Par detectability measure is used to quantify the perceptual cost of errors defined by the pressure matching approach.

In doing so, the reproduction error detectability $\text{RED}_\zz^{(m)}$ and the leakage error detectability $\text{LED}_\zz^{(m)}$
per control point $m$ were introduced.

The original pressure matching approach from \autoref{ch:sound_zone:approaches} operates on full-length input sequences in the time-domain.
The detectability however operates on short-time segments of 20 to 200 milliseconds in the frequency-domain.
As such, in order to define the reproduction error detectability and the leakage error detectability, this section proposes a short-time
frequency-domain pressure matching approach.

First, the existing pressure matching approach is reformulated to operate on short-time segments through a ``block-based'' approach. 
Here, where smaller ``blocks'' of samples are processed block-by-block rather than processing the full-length input sequence in its entirety.

% Aside from ease of integrating a perceptual model, there is another motivation for using a block-based approach.
% In the preceding section it is assumed that the desired playback signals $s_\za[n]$ and $s_\zb[n]$ were known in their entirety.
% In practice however, this is not a valid assumption as a user can change the desired playback content in real-time.
% This is the case for example when a user changes the song they are playing on their system.

% In reality, the sound zone system can only have knowledge of the most recent samples and all previous samples.
% In order to deal with this limitation, one option is to buffer a large number of incoming samples and apply the existing MZ-PM approach.
% However, this would introduce significant latency to the system.
% Instead, a block-based approach can be used where the incoming samples of the desired playback signals are used in real-time as they become available.
% The system buffers a block of $H$ incoming samples samples, and then solves the sound zone problem finding the newest block of loudspeaker input signals.

% For these reasons, this section will adapt existing pressure matching approach introduced in 
% \autoref{ch:sound_zone:approaches} to accommodate for block based processing.
% This will be done by first modeling the knowledge limitation of the block-based processing on the desired playback signals.

\subsection{Block-Based Data Model}
% For the block-processing based sound zone approach, the incoming samples of the desired playback signals 
% $s_\zz[m]$ for $\zz\in\left\{\za,\zb\right\}$ are assumed to be buffered into blocks of size $H$.
% This means that the system waits until it has a block of size $H$ before revealing the new samples to the sound zone system.

% This introduces a knowledge limitation in the desired playback signals, which requires the sound zone algorithm to be redesigned.
% In this section, this knowledge limitation will be modeled.

% The sound zone system only has knowledge of all previous blocks and the most recent block, indexed by block index $\mu$.
% The relation between the global time index $n$ and block index $\mu$ is given as follows:  
% \begin{equation}
%     \mu(n) = \lfloor n / H \rfloor
% \end{equation}
% Thus at a time $n$, up to and including the $\mu^\text{th}$ blocks of desired playback signals $s_\zz[n]$ are known.
In order to operate on short-time segments, all quantities introduced in the data model from \autoref{ch:sound_zone:data_model}
are converted to their short-time equivalent representations.
This is done by considering overlapping blocks of samples of the quantities.
Here, the blocks are each of size $N_w$ and $N_w - H$ samples.
The constant $H$ denotes the hop size, which is the number of samples between each successive block.

First, the short-time equivalent representations of the desired playback signal $s_{\zz}[n]$ and the loudspeaker input
signals $x^{(l)}_{\zz}[n]$ for zone $\zz$ and loudspeaker $l$ are given.  

In order to obtain a short-time representation, $s_\zz[n]$ and $x^{(l)}_{\zz}[n]$ will be split up into multiple overlapping blocks by using shifted windows $w[n - kH]$. 

The window $w[n]\in\Real{H}$ is a non-causal window with support $-N_w + 1 \leq n \leq 0$. 
Here, $w[n]$ is chosen such that it is COLA-condition compliant for hop size $H$.
The COLA condition requires that the the sum of all shifted windows add to unity for all samples $n$ for a given hop size $H$. 
It is given as follows:
\begin{equation}
     \sum_{k=-\infty}^{\infty} w[n - kH] = 1 \quad\forall\,n
\end{equation}
Using the windows as defined above, consider the following representation of $s_\zz[n]$,
\begin{equation}
    \begin{aligned}
        s_\zz[n] &= s_\zz[n]\sum_{k=-\infty}^{\infty} w[n - kH] \\
                 &= \sum_{k=-\infty}^{\infty} \tilde{s}_{\zz,k}[n]w[n - kH]
    \end{aligned}
\end{equation}
and of $x^{(l)}_{\zz}[n]$,
\begin{equation}
    \begin{aligned}
        x^{(l)}_\zz[n] &= x^{(l)}_\zz[n]\sum_{k=-\infty}^{\infty} w[n - kH] \\
                       &= \sum_{k=-\infty}^{\infty} \tilde{x}^{(l)}_{\zz,k}[n]w[n - kH]
    \end{aligned}
\end{equation}
Here, $\tilde{s}_{\zz,k}[n]$ and $\tilde{x}^{(l)}_{\zz,k}[n]$ represent the content of the $k^\text{th}$ blocks of the playback signal $s_{\zz}[n]$ and loudspeaker input signals $x^{(l)}_{\zz}[n]$.

As such, $\tilde{s}_{\zz,k}[n] = s_{\zz}[n]$ and $\tilde{x}^{(l)}_{\zz,k}[n] = s_{\zz}[n]$ for $-N_w + 1 + kH \leq n \leq kH$ and zero for all other samples $n$.  
The windows decimate the signal, into segments of size $N_w$, which, due to the COLA condition, can be reconstructed perfectly.

One way of interpreting the equations above is as a projection of $s_\zz[n]$ and $x^{(l)}_{\zz}[n]$ on a 
basis spanned by shifted overlapping windows $w[n - kH]$.
Here, $\tilde{s}_{\zz,k}[n]$ and $\tilde{x}^{(l)}_{\zz,k}[n]$ can be thought of as the coefficients for the basis functions resulting from the projection.

Let $\tilde{s}_\zz[n, \mu]$ and $\tilde{x}^{(l)}_\zz[n, \mu]$ represent the desired playback signal and the loudspeaker input signals with the contributions of the first $\mu$ blocks. 
This can be expressed as follows:
\begin{align}
    \tilde{s}_\zz[n, \mu] &= \sum_{k=-\infty}^{\mu} \tilde{s}_{\zz,k}[n]w[n - kH] \\
    \tilde{x}^{(l)}_\zz[n, \mu] &= \sum_{k=-\infty}^{\mu} \tilde{x}^{(l)}_{\zz,k}[n]w[n - kH]
\end{align}
This form will converge to the real desired playback signal as $\mu\to\infty$.
As such, $\tilde{s}_\zz[n, \infty] = s_\zz[n]$ and $\tilde{x}^{(l)}_\zz[n, \infty] = x^{(l)}_\zz[n]$.

This representation is beneficial, as it can be used to show that the $\tilde{x}^{(l)}_\zz[n, \mu]$ can be computed recursively:
\begin{align}
    \tilde{x}^{(l)}_\zz[n, \mu] &= \tilde{x}^{(l)}_{\zz,\mu}[n]w[n - \mu H] +
                               \sum_{k=-\infty}^{\mu - 1} \tilde{x}^{(l)}_{\zz,k}[n]w[n - kH] \\
                           &=  \tilde{x}^{(l)}_{\zz,\mu}[n]w[n - \mu H] + \tilde{x}^{(l)}_\zz[n, \mu - 1]
\end{align}
As the newest block depends on the previous blocks, this represent shows that $x^{(l)}_\zz[n]$ can be computed block-by-block.

With the block-based equivalents of the desired playback signal $\tilde{s}_\zz[n, \mu]$ and the loudspeaker input signals $\tilde{s}_\zz[n, \mu]$ defined,
the block-based equivalents of the target and achieved sound pressure $\tilde{t}_\zz[n, \mu]$ and $\tilde{p}^{(m)}_\zz[n, \mu]$ can be computed: 

\begin{itemize}
    \item 
        The block-based target sound pressure $\tilde{t}^{(m)}[n, \mu]$ can be defined by simply 
        substituting the definition for the block-based desired playback signal $\tilde{s}_\zz[n, \mu]$ into the definition of the target pressure \autoref{}:
        \begin{equation}
            \begin{aligned}
                \tilde{t}^{(m)}[n, \mu] &= \sum_{l=0}^{N_L-1} \left(h^{(l,m)} \ast \tilde{s}_\zz[\mu]\right)[n]\\
                                        &= \sum_{l=0}^{N_L - 1}\sum_{k=-\infty}^{\mu}\left(h^{(l,m)}\ast\tilde{s}_{\zz,k}w_k\right)[n] \\
                                   &= \sum_{l=0}^{N_L-1}\left(h^{(l,m)}\ast\tilde{s}_{\zz,\mu}w_\mu\right)[n] + \tilde{t}^{(m)}[n, \mu - 1]  
            \end{aligned}
        \end{equation}
        Here, $w_k[n]$ is defined to be equal to $w[n - kH]$ and is introduced for notational convenience.  
        The definition above holds for all points $m\in Z$, i.e. the points contained in zone $\zz$.  

        As can be seen, the block based target sound pressure for the block $\mu$ can be computed recursively by adding the contribution of the newest block 
        $\tilde{s}_{\zz,\mu}[n]$ the target sound pressure of the previous block.
    \item 
        The block-based resulting sound pressure $\tilde{p}_\zz^{(m)}[n, \mu]$ can be defined by simply 
        substituting the definition for the block-based loudspeaker input signals $\tilde{x}_\zz^{(l)}[n, \mu]$ into the definition of the resulting pressure \autoref{}.
        This results in the following: 
        \begin{equation}
            \begin{aligned}
                \tilde{p}_\zz^{(m)}[n, \mu] &= \sum_{l=0}^{N_L-1} \left(h^{(l,m)} \ast \tilde{x}^{(l)}_\zz[\mu]\right)[n]\\
                                            &= \sum_{l=0}^{N_L - 1}\sum_{k=-\infty}^{\mu}\left(h^{(l,m)}\ast\tilde{x}^{(l)}_{\zz,k}w_k\right)[n] \\
                                            &= \sum_{l=0}^{N_L-1}\left(h^{(l,m)}\ast\tilde{x}^{(l)}_{\zz,\mu}w_\mu\right)[n] + \tilde{p}_\zz^{(m)}[n, \mu - 1]  
 
            \end{aligned}
        \end{equation}
        The definition above again holds for all points $m\in Z$.  

        As can be seen, the block based resulting sound pressure for the block $\mu$ can also be computed recursively.
\end{itemize}

With this,  all quantities required for the block-based formulation of the pressure matching approach are defined.
The next section will use these quantities to state the block-based MZ-PM algorithm.

\subsection{Derivation of Block-Based Multi-Zone Pressure-Matching}
After translating the loudspeaker input signals and the target sound pressure into their block-wise counterparts, 
the Block-Based Multi-Zone Pressure-Matching (BB-MZ-PM) algorithm can be stated.

As mentioned before, the approach that will be taken is to compute the $\mu^\text{th}$ coefficient of the loudspeaker input signal
$\tilde{x}^{(l)}_{\zz,\mu}$ such that the resulting sound pressure $\tilde{p}_\zz^{(m)}[n, \mu]$ best matches the target sound pressure 
$\tilde{t}^{(m)}[n, \mu]$. 

Note that in this approach only the most recent loudspeaker coefficients $\tilde{x}^{(l)}_{\zz,\mu}$ are being controlled. 
The previous coefficients are assumed to have already been played.
As such, they are held fixed.

The block-based optimization problem can be found by simply replacing all quantities in the previously derived optimization problem
with their block-based counterparts.
The problem is given as follows:
\begin{align}
    \argmin{\tilde{x}_{\za,\mu}^{(l)}[n],\,\tilde{x}_{\zb,\mu}^{(l)}[n]\,\forall\,l}{
       &\sum_{m\in A} \norm[2][2]{\tilde{p}_{\za}^{(m)}[n,\mu] - \tilde{t}_\mu^{(m)}[n,\mu]} +
       \sum_{m\in A} \norm[2][2]{\tilde{p}_{\zb}^{(m)}[n,\mu]} + \\
       &\sum_{m\in B} \norm[2][2]{\tilde{p}_{\zb}^{(m)}[n,\mu] - \tilde{t}_\mu^{(m)}[n,\mu]} + 
       \sum_{m\in B} \norm[2][2]{\tilde{p}_{\za}^{(m)}[n,\mu]}
    }
\end{align}
Note that this problem implicitly contains the target sound pressure and resulting sound pressure of the previous blocks $\mu - 1$ due to
the aforementioned recursive definitions.
As a result, the history of what has been transmitted by the loudspeaker previously is included in the optimization.

The problem above is solved recursively for all loudspeaker input signal coefficients $\tilde{x}_{\za,\mu}^{(l)}[n]$ and $\tilde{x}_{\zb,\mu}^{(l)}[n]$
as new blocks $\tilde{s}_{\za,\mu}[n]$ and $\tilde{s}_{\zb,\mu}[n]$ are revealed.
The final loudspeaker input signals $\tilde{x}_\zz^{(l)}[n, \infty]$  can then be found by means of \autoref{}.

\todo{FREQ DOMAIN START}
In the previous section, a block-based multi-zone pressure matching algorithm was derived.
When deriving this algorithm it was stated that it's advantages are twofold.

Firstly, one advantage of using this algorithm over its non block-based counterpart is that it can work in real-time.
Secondly, the block-based approach can operate on short time-scales.
This is useful, as the perceptual model that we wish to integrate operates on time-scales of the order of 20 to 200 milliseconds.

There is however an additional adjustment that needs to be made before the perceptual model can be integrated. 
Currently, the block based pressure matching algorithm minimizes the sound pressure errors in the time-domain, whereas the detectability is computed in the 
frequency domain.
In order to integrate the perceptual model and the sound zone algorithm, they must operate in the same domain.

In this case, it was chosen to use convert the existing sound zone algorithm to one that operates in the frequency domain.
This was chosen as to remain close to the definition of the detectability.
Approximating detectability in the time domain was not explored further and could potentially be of interest for future work.

To this end, this section will adjust the existing time domain block based pressure matching algorithm to an equivalent frequency domain formulation.
This will be done by first introducing a suitable transformation relating the time and frequency domain quantities.
The transformed quantities can than be used define the frequency domain version of the block based pressure matching algorithm.

\subsection{Frequency Domain Transformation}
A suitable transform to obtain the frequency domain representation of a signal is the DFT.
However, it is important to take a number of precautions before applying the DFT directly,
as the computation of the sound pressures used in the optimization problem introduced previously involves taking the 
linear convolution of the loudspeaker input signals with the room impulse responses.

Time domain circular convolution can be computed in the frequency domain through the Hadamard product.
Time domain circular convolution coincides with time domain linear convolution only if the two operands are zero-padded sufficiently.
To be specific, both operands need be zero-padded to the length of the resulting convolution.

As such, the frequency domain transform requires this zero padding to be built in.
The convolutions described in the previous chapter are between the window coefficients of size $N_w$ 
and the room impulse responses of size $N_h$.
Thus, the both must be zero padded to convolution length $N_w + N_h - 1$ before going to the frequency domain.

A suitable transform is thus given by a $N_w + N_h - 1$ point DFT.
\begin{equation}
    X[k] = \sum_{n=0}^{N_w + N_h - 2} x[n]\exp\left(\frac{-j2\pi k n}{N_w + N_h - 1}\right)
\end{equation}
Here, $x[n]$ and $X[k]$ are the time- and frequency-domain representations of an arbitrary sequence.  

\subsection{Quantities the Frequency Domain}
In this section, the quantities used in the Block-Based Multi-Zone Pressure-Matching approach will be converted to their frequency domain counterparts.

Essentially, this involves converting the sound pressures $\tilde{p}_{\zz}^{(m)}[n,\mu]$ and $\tilde{t}^{(m)}[n,\mu]$ 
to their frequency domain versions given by $\tilde{P}_{\zz,\mu}^{(m)}[k]$ and $\tilde{T}_\mu^{(m)}[k]$ respectively.

This can be done by applying the previously derived transform directly to these quantities.
This results in the following expressions.
\begin{align}
    \tilde{T}^{(m)}[k, \mu] &= \tilde{T}^{(m)}[k, \mu - 1] + \sum_{l=0}^{N_L}H^{(l,m)}[k]\tilde{S}_{\zz,\mu}[k] \\
    \tilde{P}_\zz^{(m)}[k, \mu] &= \tilde{P}_\zz^{(m)}[k, \mu - 1] 
        + \sum_{l=0}^{N_L}H^{(l,m)}[k]\tilde{X}^{(l)}_{\zz,\mu}[k]  
\end{align}
Here, $H^{(l,m)}[k]\in\Complex{N_w + N_h - 1}$ is the transformed version of the room impulse responses.
Furthermore, $\tilde{S}_{\zz,\mu}[k]\in\Complex{N_w + N_h - 1}$ and 
$\tilde{X}^{(l)}_{\zz,\mu}[k]\in\Complex{N_w + N_h - 1}$ are the frequency domain versions of
the desired playback signal and the loudspeaker input signal, which are defined as follows:
\begin{align}
    \tilde{S}_{\zz,\mu}[k] &= \sum_{n=0}^{N_w + N_h - 2} \tilde{s}_{\zz,\mu}[n]w[n - \mu H]
        \exp\left(\frac{-j2\pi k n}{N_w + N_h - 1}\right) \\
    \tilde{X}^{(l)}_{\zz,\mu}[k] &= \sum_{n=0}^{N_w + N_h - 2} \tilde{x}^{(l)}_{\zz,\mu}[n]w[n - \mu H]
        \exp\left(\frac{-j2\pi k n}{N_w + N_h - 1}\right)
\end{align}

Note that the window is implicitly included in the transformed quantities.
This is done for ease of notation.

\subsection{Proposed Frequency Domain Approach}
Using the previously derived quantities, it is possible express the frequency domain version of the 
Block-Based Multi-Zone Pressure-Matching (BB-MZ-PM) approach as follows:
\begin{align}
    \argmin{\tilde{x}_{\za,\mu}^{(l)}[n],\,\tilde{x}_{\zb,\mu}^{(l)}[n]\,\forall\,l}{
       &\sum_{m\in A} \norm[2][2]{\tilde{P}_{\za}^{(m)}[k,\mu] - \tilde{T}^{(m)}[k,\mu]} +
        \sum_{m\in A} \norm[2][2]{\tilde{P}_{\zb}^{(m)}[k,\mu]} + \\
       &\sum_{m\in B} \norm[2][2]{\tilde{P}_{\zb}^{(m)}[k,\mu] - \tilde{T}^{(m)}[k,\mu]} + 
        \sum_{m\in B} \norm[2][2]{\tilde{P}_{\za}^{(m)}[k,\mu]}
    }
\end{align}
Note how the optimization is still performed over the time domain signal.
This was done to constrain the loudspeaker input signal coefficient to size $N_w$, 
as that is an assumption made by the frame-based processing.

In principal, this introduces more complexity than solving directly over the frequency domain loudspeaker input coefficient
$\tilde{X}^{(l)}_{\zz,\mu}[k]$.
This however introduces issues as it requires the truncation of the time-domain version to $N_w$ samples, which 
was found to introduce artifacts.
