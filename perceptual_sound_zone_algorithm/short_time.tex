In the preceding section it is assumed that the desired playback signals $s_\za[n]$ and $s_\zb[n]$ were known in their entirety.
In practice however, this is not a valid assumption as a user can change the desired playback content in real-time.
This is the case for example when a user changes the song they are playing on their system.

In reality, the sound zone system can only have knowledge of the most recent samples and all previous samples.
In order to deal with this limitation, one option is to buffer a large number of incoming samples and apply the existing MZ-PM approach.
However, this would introduce significant latency to the system.

Instead, a block-based approach can be used where the incoming samples of the desired playback signals are used in real-time as they become available.
The system buffers a block of $H$ incoming samples samples, and then solves the sound zone problem finding the newest block of loudspeaker input signals.

In addition to this, block-based approach is also practical for the integration of the perceptual model.
The perceptual model is designed to operate on short time segments in the order of 20 to 200 milliseconds.
Block-based approaches would allow the algorithm to operate on segments of this time scale.

For these reasons, this section will adapt existing Multi-Zone Pressure Matching approach introduced in 
\autoref{sec:data_model:pressure_matching} to accommodate for block based processing.
This will be done by first modeling the knowledge limitation of the block-based processing on the desired playback signals.

\subsection{Modeling Block Based Knowledge Limitations}
For the block-processing based sound zone approach, the incoming samples of the desired playback signals 
$s_\zz[m]$ for $\zz\in\left\{\za,\zb\right\}$ are assumed to be buffered into blocks of size $H$.
This means that the system waits until it has a block of size $H$ before revealing the new samples to the sound zone system.

This introduces a knowledge limitation in the desired playback signals, which requires the sound zone algorithm to be redesigned.
In this section, this knowledge limitation will be modeled.

The sound zone system only has knowledge of all previous blocks and the most recent block, indexed by block index $\mu$.
The relation between the global time index $n$ and block index $\mu$ is given as follows:  
\begin{equation}
    \mu(n) = \lfloor n / H \rfloor
\end{equation}
Thus at a time $n$, up to and including the $\mu^\text{th}$ blocks of desired playback signals $s_\zz[n]$ are known.

Let the available knowledge of the desired playback signal with knowledge of blocks up to $\mu$ be denoted as $\tilde{s}^R_\zz[n, \mu]$.
It can be defined as follows:
\begin{align}
    \tilde{s}^R_\zz[n, \mu] = \sum_{k=-\infty}^{\mu} \tilde{s}^R_{\zz,k}[n]w^R_H[n - kH]
\end{align}
Here, $w^R_H[n]\in\Real{H}$ is a non-causal rectangular window with support $-H + 1 \leq n \leq 0$. 
Furthermore, $\tilde{s}^R_{\zz,k}[n]$ is the $k^\text{th}$ block of the playback signal $s_{\zz}[n]$.
As such, $\tilde{s}^R_{\zz,k}[n] = s_{\zz}[n]$ for $-H + 1 + kH \leq n \leq kH$ (and zero elsewhere).  

One way of interpreting the equation above is as a projection of $s_\zz[n]$ on a 
basis spanned by shifted non-overlapping rectangular windows $w^R_H[n - kH]$.
Here, $\tilde{s}^R_{\zz,k}[n]$ can be thought of as the coefficients for the basis functions resulting from the projection.

Expressing it this way reveals that a more general approach is possible:
as shown, desired playback signals are projected onto non-causal non-overlapping rectangular windows of size $H$.
This model can however be generalized to a larger class of windows.

Let $w[n]\in\Real{N_w}$ denote a non-causal window with support $-N_w + 1 \leq n \leq 0$.
Here, $w[n]$ is chosen such that it is COLA-condition compliant for hop size $H$.
The COLA condition requires that the the sum of all shifted windows add to unity for all samples $n$ for a given hop size $H$. 
It is given as follows:
\begin{equation}
     \sum_{k=-\infty}^{\infty} w[n - kH] = 1 \quad\forall\,n
\end{equation}
Projecting $s_\zz[n]$ onto a basis spanned by the shifted windows $w[n - kH]$ results in the following:
\begin{align}
    s_\zz[n] &= \sum_{k=-\infty}^{\infty} s_\zz[n]w[n - kH] \\
             &= \sum_{k=-\infty}^{\infty} \tilde{s}_\zz[n]w[n - kH]
\end{align}
Here, $\tilde{s}_{\zz,k}[n] = s_{\zz}[n]$ for $-N_w + 1 + kH \leq n \leq kH$ and zero elsewhere.  
The windows decimate the signal $s_\zz[n]$ into segments of size $N_w$. 
Due to the COLA condition, this the segments reconstruct the 

This allows us to express the desired playback signal with knowledge up to block $\mu$ as follows:
\begin{align}
    \tilde{s}_\zz[n, \mu] = \sum_{k=-\infty}^{\mu} \tilde{s}_{\zz,k}[n]w[n - kH]
\end{align}
This form will converge to the real desired playback signal as $\mu\to\infty$.
Aside from being more general, this approach allows for use of overlapping windows.
This was found to be beneficial, as overlapping windows were found to reduce edge effects in the resulting loudspeaker input signals.

\subsection{Block Based Loudspeaker Input Signal Computation}
As mentioned in the introduction, the block-based approach aims to compute the loudspeaker input signals at the same
rate as the desired playback signals $s_\zz[n]$ are received.
That is to say: when a new block $\mu$ of the desired playback signal is revealed, a new block $\mu$ of 
loudspeaker input signals need be computed.

In order to compute the loudspeaker input signals in this block-wise fashion, 
a similar decomposition as for the desired playback signals is performed.
Consider decomposing the loudspeaker input signals in blocks through the windows as follows:
\begin{align}
    \tilde{x}^{(l)}_\zz[n, \mu] &= \sum_{k=-\infty}^{\mu} \tilde{x}^{(l)}_{\zz,k}[n]w[n - kH] \\
                           &= \sum_{k=-\infty}^{\mu - 1} \tilde{x}^{(l)}_{\zz,k}[n]w[n - kH] 
                                + \tilde{x}^{(l)}_{\zz,\mu}[n]w[n - \mu H] \\
                           &= \tilde{x}^{(l)}_\zz[n, \mu - 1] + \tilde{x}^{(l)}_{\zz,\mu}[n]w[n - \mu H]
\end{align}
The equation above shows that $\tilde{x}^{(l)}_\zz[n]$ can be computed by recursively computing its coefficients
$\tilde{x}^{(l)}_{\zz,k}$ and adding them.
Note that this recursive property also holds for the desired playback signal $\tilde{s}_\zz[n]$. 

The approach to find $\tilde{x}^{(l)}_\zz[n] $ is now as follows.
When the $\mu^\text{th}$ block of the desired playback signals is revealed, this will allow for the calculation of the 
corresponding target sound pressure.
Next, the $\mu^{\text{th}}$ coefficient $\tilde{x}^{(l)}_{\zz,\mu}$ is computed such that $\tilde{x}^{(l)}_\zz[n]$
attains this target sound pressure.

How $\tilde{x}^{(l)}_\zz[n]$ and $\tilde{s}_\zz[n]$ relate to the resulting and target sound pressure respectively
is the topic of the next section.

\subsection{Block Based Sound Pressure}
As discussed previously, the Multi-Zone Pressure-Matching (MZ-PM) algorithm attempts to 
control the loudspeaker input signals 
$x^{(l)}_\zz[n]$ for $\zz\in\left\{\za,\zb\right\}$ such that the resulting sound pressure matches a 
specified target sound pressure $t^{(m)}[n]$ at all control points $m$.

Previous sections gave block-based versions of the loudspeaker input signals and the desired playback signals.
In this section, block-based versions of the resulting and target sound pressure will be given. 

The block-based target sound pressure will be denoted by $\tilde{t}^{(m)}[n, \mu]$, and can be defined by simply 
substituting the definition for the block-based desired playback signal $\tilde{s}_\zz[n, \mu]$ into the definition of the target pressure \autoref{}:
\begin{align}
    \tilde{t}^{(m)}[n, \mu] &= \sum_{l=0}^{N_L} \left(h^{(l,m)} \ast \tilde{s}_\zz\right)[n]\\
                       &= \sum_{l=0}^{N_L}\sum_{k=-\infty}^{\mu}\sum_{m=0}^{N_h - 1}h^{(l,m)}[m]\tilde{s}_{\zz,k}[n - m]w[n - kH - m] \\
                       &= \tilde{t}^{(m)}[n, \mu - 1] + \sum_{l=0}^{N_L}\sum_{m=0}^{N_h - 1}h^{(l,m)}[m]\tilde{s}_{\zz,\mu}[n - m]w[n - \mu H - m] 
\end{align}
The definition above holds for all points $m\in Z$, the points contained in zone $\zz$.  
As can be seen, the block based target sound pressure for the block $\mu$ can be computed recursively by adding the contribution of the newest block 
$\tilde{s}_{\zz,\mu}[n]$ the target sound pressure of the previous block.

The block-based resulting sound pressure will be denoted by $\tilde{p}_\zz^{(m)}[n, \mu]$, and can be defined by simply 
substituting the definition for the block-based loudspeaker input signals $\tilde{x}_\zz^{(l)}[n, \mu]$ into the definition of the resulting pressure \autoref{}.
This results in the following: 
\begin{align}
    \tilde{p}_\zz^{(m)}[n, \mu] &= \sum_{l=0}^{N_L} \left(h^{(l,m)} \ast \tilde{x}^{(l)}_\zz\right)[n]\\
                       &= \sum_{l=0}^{N_L}\sum_{k=-\infty}^{\mu}\sum_{m=0}^{N_h - 1}h^{(l,m)}[m]\tilde{x}^{(l)}_{\zz,k}[n - m]w[n - kH - m] \\
                       &= \tilde{p}_\zz^{(m)}[n, \mu - 1] + \sum_{l=0}^{N_L}\sum_{m=0}^{N_h - 1}h^{(l,m)}[m]\tilde{x}^{(l)}_{\zz,\mu}[n - m]w[n - \mu H - m]  
\end{align}
The definition above again holds for all points $m\in Z$.  
As can be seen, the block based resulting sound pressure for the block $\mu$ can also be computed recursively.

With this,  all quantities required for the block-based formulation of the Multi-Zone Pressure-Matching (MZ-PM) approach are known.
The next section will use these quantities to state the block-based MZ-PM algorithm.

\subsection{Derivation of Block-Based Multi-Zone Pressure-Matching}
After translating the loudspeaker input signals and the target sound pressure into their block-wise counterparts, 
the Block-Based Multi-Zone Pressure-Matching (BB-MZ-PM) algorithm can be stated.

As mentioned before, the approach that will be taken is to compute the $\mu^\text{th}$ coefficient of the loudspeaker input signal
$\tilde{x}^{(l)}_{\zz,\mu}$ such that the resulting sound pressure $\tilde{p}_\zz^{(m)}[n, \mu]$ best matches the target sound pressure 
$\tilde{t}^{(m)}[n, \mu]$. 

Note that in this approach only the most recent loudspeaker coefficients $\tilde{x}^{(l)}_{\zz,\mu}$ are being controlled. 
The previous coefficients are assumed to have already been played.
As such, they are held fixed.

The block-based optimization problem can be found by simply replacing all quantities in the previously derived optimization problem
with their block-based counterparts.
The problem is given as follows:
\begin{align}
    \argmin{\tilde{x}_{\za,\mu}^{(l)}[n],\,\tilde{x}_{\zb,\mu}^{(l)}[n]\,\forall\,l}{
       &\sum_{m\in A} \norm[2][2]{\tilde{p}_{\za}^{(m)}[n,\mu] - \tilde{t}_\mu^{(m)}[n,\mu]} +
       \sum_{m\in A} \norm[2][2]{\tilde{p}_{\zb}^{(m)}[n,\mu]} + \\
       &\sum_{m\in B} \norm[2][2]{\tilde{p}_{\zb}^{(m)}[n,\mu] - \tilde{t}_\mu^{(m)}[n,\mu]} + 
       \sum_{m\in B} \norm[2][2]{\tilde{p}_{\za}^{(m)}[n,\mu]}
    }
\end{align}
Note that this problem implicitly contains the target sound pressure and resulting sound pressure of the previous blocks $\mu - 1$ due to
the aforementioned recursive definitions.
As a result, the history of what has been transmitted by the loudspeaker previously is included in the optimization.

The problem above is solved recursively for all loudspeaker input signal coefficients $\tilde{x}_{\za,\mu}^{(l)}[n]$ and $\tilde{x}_{\zb,\mu}^{(l)}[n]$
as new blocks $\tilde{s}_{\za,\mu}[n]$ and $\tilde{s}_{\zb,\mu}[n]$ are revealed.
The final loudspeaker input signals $\tilde{x}_\zz^{(l)}[n, \infty]$  can then be found by means of \autoref{}.
